FIGURES MASTER BLUEPRINT (ICML) — COMPLETE ENGINEERING SPEC
================================================================================

IMPORTANT: THIS FILE IS SELF-CONTAINED
  You are a design/figure engineer. Assume zero domain context outside this file.
  Build all figures strictly from this specification.

PROJECT IN ONE PAGE (FOR CONTEXT)
--------------------------------------------------------------------------------
Problem:
  Predict photovoltaic J-V curves from simulated device parameters.

Domain:
  Perovskite solar-cell surrogate modeling.

Inputs to model:
  - 31 numeric COMSOL-derived device/material parameters.
  - 2 scalar inputs loaded from external text files: Voc and Vmpp.

Output:
  - Reconstructed current curve I(V) on an 8-point voltage slice.
  - Optional reconstruction to dense voltage grid for visualization.

Primary model (flagship):
  - ParamMLP -> Gaussian RBF(V) -> Dilated 1D Conv blocks -> Output head.
  - No attention.

Loss:
  L = MSE + lambda_mono * L_mono + lambda_conv * L_conv + lambda_curv * L_curv
  where:
    L_mono penalizes dI/dV > 0,
    L_conv penalizes wrong curvature sign near knee,
    L_curv penalizes excess oscillatory curvature.

Data regime:
  - Source datasets: "100k" and "300k".
  - Usable after upstream curation: 66k and 176k samples.
  - Default training uses both (combined).

Visual goals for paper:
  1) Show method is physically grounded and ML-strong.
  2) Show why dilated conv is preferred.
  3) Show interpolation/curve representation fidelity.
  4) Show attention is a negative control.
  5) Show robustness and pipeline practicality.

--------------------------------------------------------------------------------
GLOBAL DESIGN SYSTEM (MANDATORY)
--------------------------------------------------------------------------------

1) Size and layout standards
  - ICML two-column target.
  - Full-width figure canvas: 17.0 cm wide.
  - Half-width figure canvas: 8.2 cm wide.
  - Max height main figures: 8.8 cm.
  - Max height appendix figures: 9.8 cm.
  - Internal margins: 3–6 mm equivalent spacing between subpanels.

2) Typography
  - All figure text in sans-serif (\sffamily).
  - Panel title: \small\bfseries.
  - Axis labels: \small.
  - Tick labels: \scriptsize.
  - Legend text: \scriptsize.
  - Callout text: \scriptsize.
  - Never smaller than \tiny unless absolutely unavoidable.

3) Color system (fixed mapping)
  - Ink (primary text/line):         #1F2937
  - Flagship model (Dilated Conv):   #2563EB
  - Secondary comparison:            #D97706
  - Physics-consistent / good:       #059669
  - Error / degraded / negative:     #BE123C
  - Muted axis/text:                 #64748B
  - Panel bg/callout bg:             #F8FAFC
  - Grid line:                       #E2E8F0
  - Highlight zone (MPP):            #F59E0B (light alpha fill)

4) Plot conventions
  - Primary curve line width: 1.4–1.6 pt.
  - Secondary curve line width: 1.0–1.2 pt.
  - Guide/dashed lines: 0.45–0.8 pt.
  - Legends compact, top-right unless overlap risk.
  - Use short direct labels where possible.

5) Mandatory quality checks before export
  - Labels readable at 100% zoom in a two-column PDF.
  - No overlapping text/markers.
  - At least one visual takeaway callout in every multi-panel figure.
  - Color meaning consistent with mapping above.
  - Panel labels (a), (b), (c) for multi-panel figures.

--------------------------------------------------------------------------------
DATA ASSUMPTIONS + SCIENTIFIC SIGNAL SHAPES (MANDATORY)
--------------------------------------------------------------------------------

J-V curve shape assumptions:
  - Voltage domain displayed in figures: 0 to 1.4 V.
  - Typical Voc is around ~1.2 V.
  - Typical Isc can be drawn around ~300 (if absolute scale used).
  - High fill-factor good curve: bowed outward, steep knee near Vmpp.
  - Bad curve archetype: concave-up/near-linear slide, low Voc and low Vmpp.

Interpolation sampling:
  - 8-point representation around MPP region (PCHIP-based reconstruction).

When no final data is available:
  - Use realistic placeholder data exactly matching above morphology.
  - Clearly mark in figure source comments: "placeholder synthetic data".

--------------------------------------------------------------------------------
FIGURE LIST SUMMARY
--------------------------------------------------------------------------------
Main paper (6):
  F1  fig1_pipeline.tex                         [UPGRADE]
  F2  fig2_conv_receptive_field.pdf             [NEW]
  F3  fig3_interpolation_fidelity_pair.pdf      [NEW, from provided PNGs]
  F4  fig4_voltage_grid.tex                     [KEEP, clarified]
  F5  fig_ablation_attention_combo.pdf          [NEW]
  F6  fig_scalar_to_curve_robustness.pdf        [NEW]

Appendix (11):
  A1  fig_a1_architecture_detail.pdf            [NEW]
  A2  fig_a2_preprocessing_flow.pdf             [NEW]
  A3  fig_a3_feature_streamline.pdf             [NEW]
  A4  fig_a4_jacobian_heatmap.pdf               [NEW]
  A5  fig_a5_tornado.pdf                        [NEW]
  A6  fig_a6_runtime_breakdown.pdf              [NEW]
  A7  fig_a7_data_scaling.pdf                   [NEW]
  A8  fig_a8_error_gallery.pdf                  [NEW]
  A9  fig_a9_ood_uncertainty.pdf                [NEW]
  A10 fig_a10_comsol_pde_context.tex            [HOLDER]
  A11 fig_a11_curve_representation_fidelity.pdf [NEW]

Deprecated (do not build):
  - fig2_feasible_set.tex
  - fig_a1_equations.tex

================================================================================
MAIN PAPER FIGURES — DETAILED BUILD INSTRUCTIONS
================================================================================

F1 — END-TO-END PIPELINE OVERVIEW
--------------------------------------------------------------------------------
Output file:
  figures/fig1_pipeline.tex and compiled PDF

Purpose:
  Show the exact path from physical simulator parameters to final curve prediction,
  highlighting model architecture and physics-informed loss.

Canvas:
  17.0 cm x 7.5 cm (full width)

Composition (left-to-right, exactly 7 blocks):
  Block 1 title: "COMSOL Parameter Vector"
    body text:
      "x in R^31"
      "material + transport + interface params"
  Block 2 title: "Scalar TXT Inputs"
    body text:
      "Voc, Vmpp"
      "external / swappable"
  Block 3 title: "Preprocessing"
    body text:
      "group-wise log1p / robust / minmax"
      "PCHIP 8-point voltage slicing"
      "cache + split"
  Block 4 title: "ParamMLP"
    body text:
      "[256 -> 128 -> 128]"
  Block 5 title: "Positional Encoding"
    body text:
      "Gaussian RBF(V)"
  Block 6 title: "Dilated Conv Backbone"
    body text:
      "Conv1d k=5, dilations [1,2]"
      "channels [128,64]"
      "NO attention"
  Block 7 title: "Output + Physics Loss"
    body text:
      "I_hat(V) on 8 points"
      "L = MSE + mono + convex + curv"

Mandatory side callouts:
  Callout A near preprocessing:
    "Training data = 100k + 300k"
    "Usable = 66k + 176k"
  Callout B near backbone:
    "FLAGSHIP MODEL"
    "Dilated Conv (No Attention)"

Arrow behavior:
  - Thick directional arrows between each block.
  - Branch from Block 4 and Block 5 into Block 6 (merge node).

Color assignment:
  - Input blocks (1-3): muted steel + cyan accents.
  - Model blocks (4-6): blue/ink palette.
  - Output/loss block (7): emerald border with rose formula highlight.

Panel text in figure footer (one line):
  "Physics-informed sequence reconstruction with external scalar conditioning."

--------------------------------------------------------------------------------
F2 — WHY DILATED CONV WORKS
--------------------------------------------------------------------------------
Output file:
  figures/fig2_conv_receptive_field.pdf

Purpose:
  Make architecture choice visually obvious.

Canvas:
  17.0 cm x 8.0 cm

Layout: 3 panels (a,b,c) in one row

Panel (a): "Receptive Field on 8-Point Sequence"
  Content:
    - Draw four mini-rows (Pointwise, Conv, Dilated Conv, TCN).
    - Each row has 8 circular tokens labeled v1...v8.
    - Highlight dependency span for center token (e.g., v5).
  Exact visual mapping:
    Pointwise: only v5 highlighted.
    Conv (k=5): contiguous local window around v5.
    Dilated Conv: wider multi-scale pattern (non-contiguous reach).
    TCN: left-only reach (causal).
  Annotation text:
    - "Short sequence: only 8 positions"
    - "Dilation expands effective context without extra depth"

Panel (b): "Inductive Bias for This Task"
  Content:
    - 2 small cartoons:
      Cartoon 1: good bowed J-V shape with local knee detail.
      Cartoon 2: marker showing need for both local + medium context.
    - Overlay arrows labeled:
      "local slope", "knee curvature", "global drop trend".
  Takeaway box:
    "Bidirectional local context + dilation matches MPP-centered curve geometry."

Panel (c): "Performance Snapshot"
  Data display:
    - Dot+errorbar or compact bars for 4 variants:
      Pointwise, Conv-NoDil, Conv-Dilated, TCN-Dilated.
    - Metrics shown:
      MAE (left y-axis) and R2 (right y-axis) OR two stacked mini-plots.
  Legend rule:
    - Flagship (Conv-Dilated) in blue.
    - Others in amber/gray.
  Required annotation:
    "Attention variants omitted from main panel; shown as negative control in F5."

--------------------------------------------------------------------------------
F3 — INTERPOLATION FIDELITY PAIR (MANDATORY; USE PROVIDED IMAGES)
--------------------------------------------------------------------------------
Output file:
  figures/fig3_interpolation_fidelity_pair.pdf

Purpose:
  Show (i) direct visual fidelity of 8-point representation on a real J-V example,
  and (ii) quantitative saturation of accuracy vs number of interpolation points.

Canvas:
  17.0 cm x 7.8 cm

Layout: 2 panels (a,b)

Panel (a): use EXACT image file:
  - jv_curve_8_point_reconstruction_example.png
  - Keep image content unchanged (real curve + overlap).
  - Add panel label "(a)" and concise subtitle:
    "Single-curve interpolation fidelity (8-point PCHIP)"
  - Keep visible result text:
    "R^2 = 0.9939" (as provided in image or overlay).

Panel (b): use EXACT image file:
  - reconstruction_number_vs_number_of_points.png
  - Keep image content unchanged.
  - Add panel label "(b)" and concise subtitle:
    "Reconstruction quality vs interpolation-point budget"
  - Ensure 4-significant-digit values are legible.

Required combined figure caption (use verbatim unless journal style requires edits):
  "Left: Example J-V curve reconstruction using an 8-point PCHIP representation
  against a 1000-point reference, showing close overlap (R^2 = 0.9939).
  Right: Reconstruction performance as a function of interpolation-point count
  (reported to 4 significant digits). Accuracy saturates rapidly; around 10 points
  already reaches approximately 0.999, and using 12 points reaches about 0.9997.
  This is over an order of magnitude beyond the smallest observed error scale and
  provides a favorable robustness-generalization tradeoff."

Required discussion bullets in paper text (for engineer handoff awareness):
  - "Representation fidelity is not the bottleneck once point count is modest."
  - "Point budget is chosen by accuracy saturation + generalization margin."
  - "The interpolation choice preserves physically plausible bowed high-FF shape."

--------------------------------------------------------------------------------
F4 — VOLTAGE GRID + WEIGHTED ERROR RATIONALE (CLARIFIED)
--------------------------------------------------------------------------------
Output file:
  figures/fig4_voltage_grid.tex and compiled PDF

Purpose:
  Explain exactly why evaluation/training weighting is not uniform in voltage:
  denser resolution and higher importance near the knee/MPP region.

Canvas:
  17.0 cm x 7.8 cm

Layout: 2 stacked panels (a,b)

Panel (a): "Non-uniform voltage grid design"
  Required content:
    - Horizontal voltage axis from 0 to 1.4 V.
    - Region 1 ticks: coarse spacing (0 to 0.4 V).
    - Region 2 ticks: dense spacing (0.425 to 1.4 V).
    - Marker for typical Vmpp zone and typical Voc vicinity.
  Required annotation:
    - "Dense sampling in the knee/MPP regime"
    - "Coarse sampling in low-curvature region"

Panel (b): "Weighted error definition"
  Required content:
    - Equation showing delta-V weighting (or equivalent non-uniform grid compensation).
    - Optional knee-focused weighting term centered near Vmpp.
  Required annotation:
    - "Prevents low-information regions from dominating error"
    - "Aligns objective with power-critical operating region"

Required takeaway callout:
  "Resolution and weighting are intentionally concentrated where device-performance sensitivity is highest."

--------------------------------------------------------------------------------
F5 — ABLATION + ATTENTION NEGATIVE CONTROL
--------------------------------------------------------------------------------
Output file:
  figures/fig_ablation_attention_combo.pdf

Purpose:
  Present model selection and demote attention clearly.

Canvas:
  17.0 cm x 8.0 cm

Layout: 2 panels side-by-side

Panel (a): "Tier-0 Ablation Heatmap"
  Rows (exact IDs):
    T0-1 Conv-Dilated-NoAttn
    T0-2 Conv-NoDil-NoAttn
    T0-3 TCN-Dilated-NoAttn
    T0-4 Pointwise-NoAttn
    T0-5 Conv-Dilated-Attn
    T0-6 TCN-Dilated-Attn
    T0-7 NoScalars
    T0-8 100kOnly
    T0-9 200epochs
    T0-10 BS512
  Columns:
    R2_median, MAE_median, Voc_err_abs_median, Isc_err_abs_median
  Heatmap rules:
    - annotate each cell numerically (3–4 decimals)
    - colormap must be perceptually uniform and colorblind-safe

Panel (b): "Attention Impact (Paired Slopes)"
  Two paired lines:
    - Conv: NoAttn -> Attn
    - TCN:  NoAttn -> Attn
  y-axis: MAE (or inverse score) with explicit directionality
  Required annotation:
    "Both architectures degrade with attention in this short-sequence setting."

--------------------------------------------------------------------------------
F6 — SCALAR-TO-CURVE ERROR PROPAGATION
--------------------------------------------------------------------------------
Output file:
  figures/fig_scalar_to_curve_robustness.pdf

Purpose:
  Show end-to-end robustness when scalar inputs are imperfect.

Canvas:
  17.0 cm x 7.8 cm

Layout: 2 panels (a,b)

Panel (a): "Noise Sweep"
  x-axis: scalar noise level (e.g., 0%, 1%, 2%, 5%, 10%)
  y-axis: curve MAE
  Curves:
    - noise on Voc only
    - noise on Vmpp only
    - noise on both
  Add confidence bands if available.

Panel (b): "Error Transfer"
  x-axis: scalar absolute error
  y-axis: curve absolute error (MAE)
  Plot:
    - scatter or hexbin + binned trend line
  Required highlighted region:
    - "acceptable operating range" box in lower-left.

Takeaway callout:
  "Quantifies how upstream scalar quality governs final curve error budget."

--------------------------------------------------------------------------------
AUTO-GENERATED FIGURES (NOT BESPOKE TIKZ WORK)
--------------------------------------------------------------------------------

AG1 — Training curves / learning diagnostics
  Status: [AUTO]
  Source: generated directly from training logs by codebase utilities.
  Note: do NOT spend bespoke design effort here unless explicitly requested.

================================================================================
APPENDIX FIGURES — DETAILED BUILD INSTRUCTIONS
================================================================================

A1 — ARCHITECTURE DETAIL
--------------------------------------------------------------------------------
Output:
  figures/fig_a1_architecture_detail.pdf
Show exact tensor flow:
  input dims, MLP dims, RBF channel count, conv block channels, output dims.
Add one small parameter-count box.

--------------------------------------------------------------------------------
A2 — PREPROCESSING DECISION FLOW
--------------------------------------------------------------------------------
Output:
  figures/fig_a2_preprocessing_flow.pdf
Flowchart content (exact nodes):
  Raw params -> grouped transforms -> scalar scaling -> split -> cache artifacts
Include explicit reasons per transform:
  log1p (heavy tails), robust (outliers), minmax (stable NN scale).

--------------------------------------------------------------------------------
A3 — PHYSICS FEATURE STREAMLINING
--------------------------------------------------------------------------------
Output:
  figures/fig_a3_feature_streamline.pdf
Show funnel:
  71 candidate features -> correlation filter -> collinearity pruning -> m retained.
If m unavailable, annotate as variable placeholder.

--------------------------------------------------------------------------------
A4 — JACOBIAN HEATMAP
--------------------------------------------------------------------------------
Output:
  figures/fig_a4_jacobian_heatmap.pdf
Heatmap axes:
  y: top selected input features
  x: voltage positions (8 points)
Color:
  |dI_hat/dx| magnitude.
Add side bar listing top-5 sensitive features.

--------------------------------------------------------------------------------
A5 — PARAMETER PERTURBATION TORNADO
--------------------------------------------------------------------------------
Output:
  figures/fig_a5_tornado.pdf
Horizontal bars:
  top-k input parameters by induced MAE change under perturbation.
Sort descending.

--------------------------------------------------------------------------------
A6 — RUNTIME BREAKDOWN
--------------------------------------------------------------------------------
Output:
  figures/fig_a6_runtime_breakdown.pdf
Stacked or grouped bars for:
  preprocess_s, train_s, test_s, throughput_sps, latency_ms.
Include annotation of optimization settings:
  bf16, persistent workers, prefetch, heavy plotting disabled.

--------------------------------------------------------------------------------
A7 — DATA SCALING
--------------------------------------------------------------------------------
Output:
  figures/fig_a7_data_scaling.pdf
Compare 100k-only vs 100k+300k.
Must include subtitle text:
  "usable counts: 66k vs 66k+176k"
Metrics shown: MAE and R2 with error bars.

--------------------------------------------------------------------------------
A8 — ERROR GALLERY
--------------------------------------------------------------------------------
Output:
  figures/fig_a8_error_gallery.pdf
Layout:
  3x3 grid:
    top row best, middle median, bottom worst.
Each panel includes small badge:
  R2=..., MAE=...

--------------------------------------------------------------------------------
A9 — OOD / ID + UNCERTAINTY
--------------------------------------------------------------------------------
Output:
  figures/fig_a9_ood_uncertainty.pdf
Panel (a): ID vs OOD metric distributions.
Panel (b): uncertainty vs absolute error scatter.
Include trend line and correlation value if available.

--------------------------------------------------------------------------------
A10 — COMSOL PDE CONTEXT (PLACEHOLDER SHELL)
--------------------------------------------------------------------------------
Output:
  figures/fig_a10_comsol_pde_context.tex + pdf
Build only structural shell, no finalized equations required.
Required blocks:
  - "Poisson Equation"
  - "Electron Continuity"
  - "Hole Continuity"
  - "Material Parameters / Boundary Conditions"
Arrows:
  bidirectional coupling between the three PDE blocks.
Header text:
  "Coupled Drift-Diffusion-Poisson System (placeholder; domain fill-in pending)"

--------------------------------------------------------------------------------
A11 — CURVE REPRESENTATION FIDELITY (MANDATORY)
--------------------------------------------------------------------------------
Output:
  figures/fig_a11_curve_representation_fidelity.pdf

Purpose:
  Preserve explicit interpolation + representation narrative after split-spline de-emphasis.

Canvas:
  17.0 cm x 9.2 cm

Layout: 3 panels (a,b,c)

Panel (a): Good high-FF curve
  - x: 0 to 1.4 V, y: current scale chosen consistently.
  - show true, sampled points, reconstructed.
  - annotate Voc, Vmpp, Isc locations.

Panel (b): Bad-curve archetype
  - concave-up / near-linear slope with lower Voc and Vmpp.
  - same plotting style for comparability.
  - visually indicate failure signatures:
    underfit at knee, wrong curvature, misplaced endpoint behavior.

Panel (c): Quantitative representation comparison
  - bar or dot plot with methods:
    PCHIP, Linear, Baseline-spline-style
  - metrics shown:
    Knee MAE and Full MAE.
  - if real numbers unavailable, include placeholder table box with schema.

Mandatory takeaway text:
  "Representation/interpolation choice directly controls knee-region fidelity and failure mode behavior."

================================================================================
CSV SCHEMAS (FOR DATA-DRIVEN FIGURES)
================================================================================

Schema S1: ablation_metrics.csv
  columns:
    exp_id, seed, r2_median, mae_median, voc_error_abs_median, isc_error_abs_median

Schema S2: physics_learning_curves.csv
  columns:
    epoch, val_total_loss, mse_loss, mono_loss, convex_loss, curv_loss,
    mono_violation_rate, convex_violation_rate

Schema S3: scalar_to_curve_robustness.csv
  columns:
    noise_level_pct, noise_target(voc|vmpp|both), curve_mae, curve_r2

Schema S4: interpolation_fidelity.csv
  columns:
    method(pchip|linear|baseline), knee_mae, full_mae

Schema S5: runtime_breakdown.csv
  columns:
    run_name, preprocess_s, train_s, test_s, throughput_sps, latency_ms

================================================================================
DELIVERABLES + FILE RULES
================================================================================

For each figure:
  - Produce standalone source (.tex for TikZ figures).
  - Produce compiled .pdf.
  - Add top-of-file comment block with:
    - figure purpose,
    - required input schema,
    - whether values are real or placeholder.

Do not rename files.
Use filenames exactly as listed in this document.

================================================================================
FINAL QA CHECKLIST
================================================================================

[ ] Figure can be understood without reading paper body.
[ ] Scientific story is evident in <10 seconds.
[ ] Panel labels and legends are clean and non-overlapping.
[ ] Visual hierarchy highlights flagship model clearly.
[ ] Interpolation/fidelity story is explicitly present (F3 + A11).
[ ] Attention is shown only as negative control (F5).
[ ] Physics relevance visible (F1, F4, A4, A10).
[ ] Consistent ICML-quality typography/colors throughout.

================================================================================
END OF MASTER BLUEPRINT
================================================================================

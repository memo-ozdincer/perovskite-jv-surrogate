
% ============================================================
% FILE: figures/fig1_pipeline.tex
% Figure 1: End-to-End Pipeline (COMSOL -> Scalars -> Dilated Conv -> J-V)
% ============================================================
\documentclass[border=8pt]{standalone}
\usepackage{tikz}
\usepackage{amsmath,amssymb}
\usetikzlibrary{arrows.meta,calc,positioning,fit,backgrounds,decorations.pathreplacing}

\definecolor{ink}{HTML}{1F2937}
\definecolor{steel}{HTML}{334155}
\definecolor{cblue}{HTML}{2563EB}
\definecolor{amber}{HTML}{D97706}
\definecolor{emerald}{HTML}{059669}
\definecolor{rose}{HTML}{BE123C}
\definecolor{muted}{HTML}{64748B}
\definecolor{slatebg}{HTML}{F8FAFC}
\definecolor{gridc}{HTML}{E2E8F0}

\begin{document}
\begin{tikzpicture}[
  >=Stealth,
  every node/.style={font=\sffamily\small},
  block/.style={
    draw=#1!55, fill=#1!5, rounded corners=4pt,
    align=center, line width=0.6pt, inner sep=5pt
  },
  miniblock/.style={
    draw=#1!45, fill=#1!4, rounded corners=2.5pt,
    font=\sffamily\tiny, align=center,
    line width=0.4pt, inner sep=3pt
  },
  arr/.style={->, line width=0.7pt, color=muted!70},
  lbl/.style={font=\sffamily\tiny, text=muted, align=center},
]

% ── Stage 1 & 2: Parallel Inputs ──
\node[block=steel, text width=2.1cm, minimum height=1.05cm] (comsol) at (0, 0.85) {
  \textbf{\scriptsize COMSOL Inputs}\\
  {\tiny $\mathbf{x}\in\mathbb{R}^{31}$}
};
\node[lbl, below=1pt of comsol] {drift--diffusion params};

\node[block=cblue, text width=2.1cm, minimum height=1.05cm] (scalar) at (0, -0.85) {
  \textbf{\scriptsize Scalar TXT}\\
  {\tiny $V_{\text{oc}}, V_{\text{mpp}}$}
};
\node[lbl, below=1pt of scalar] {external / swappable};

% Merge indicator
\draw[arr, rounded corners=3pt]
  (comsol.east) -- ++(0.45,0) |- (3.2, 0);
\draw[arr, rounded corners=3pt]
  (scalar.east) -- ++(0.45,0) |- (3.2, 0);

% ── Stage 3: Preprocessing ──
\node[block=amber, text width=2.5cm, minimum height=1.7cm] (prep) at (4.4, 0) {
  \textbf{\scriptsize Preprocessing}\\
  {\tiny log1p\,+\,robust\,+\,min-max}\\
  {\tiny PCHIP 8-pt slices}
};
\node[lbl, below=1pt of prep, text width=2.6cm] {100k+300k source\\66k\,+\,176k usable};

\draw[arr] (3.2,0) -- (prep.west);

% ── Stage 4: Model Core ──
\node[
  draw=ink!30, fill=slatebg, rounded corners=5pt, line width=0.65pt,
  minimum width=5.4cm, minimum height=3.3cm
] (modelcard) at (9.4, 0) {};

% Title + badge
\node[font=\sffamily\scriptsize\bfseries, text=ink, anchor=north]
  at ($(modelcard.north)+(-0.5,-0.18)$) {Dilated Conv (No Attention)};
\node[
  draw=rose!50, fill=rose!7, rounded corners=4pt, line width=0.45pt,
  font=\sffamily\tiny\bfseries, text=rose, inner sep=2pt
] at ($(modelcard.north east)+(-0.65,-0.18)$) {FLAGSHIP};

% Internal layers
\node[miniblock=steel, text width=1.55cm, minimum height=0.55cm]
  (mlp) at ($(modelcard.north west)+(1.25,-0.8)$) {ParamMLP\\$256\!\to\!128$};
\node[miniblock=cblue, text width=1.55cm, minimum height=0.55cm]
  (rbf) at ($(modelcard.north east)+(-1.25,-0.8)$) {RBF\,$(V)$\\pos.\ encoding};
\node[miniblock=amber, text width=4.2cm, minimum height=0.5cm]
  (dconv) at ($(modelcard.center)+(0,0.12)$) {Dilated Conv: $k\!=\!5$,  dil\,$[1,2]$,  ch\,$[128,64]$};
\node[miniblock=emerald, text width=4.2cm, minimum height=0.45cm]
  (ohead) at ($(modelcard.center)+(0,-0.6)$) {Output head $ \to $ $\hat{J}(V)$ on 8 points};

% Internal arrows
\draw[->, line width=0.3pt, muted!60]
  (mlp.south) -- ++(0,-0.1) -| ($(dconv.north)+(-0.75,0)$);
\draw[->, line width=0.3pt, muted!60]
  (rbf.south) -- ++(0,-0.1) -| ($(dconv.north)+(0.75,0)$);
\draw[->, line width=0.3pt, muted!60] (dconv) -- (ohead);

\draw[arr] (prep.east) -- (modelcard.west);

% ── Stage 5: Physics Loss (below model) ──
\node[
  draw=rose!40, fill=rose!3, rounded corners=3.5pt,
  line width=0.5pt, font=\sffamily\tiny,
  text width=5.0cm, align=center, inner sep=4pt
] (loss) at (9.4, -2.65) {
  \textbf{Physics-informed loss}\\
  $\mathcal{L}=\mathcal{L}_{\text{MSE}} +\lambda_{m}\mathcal{L}_{\text{mono}} +\lambda_{c}\mathcal{L}_{\text{conv}} +\lambda_{k}\mathcal{L}_{\text{curv}}$
};

% Loss connection (dashed, bidirectional feel)
\draw[->, line width=0.5pt, rose!55, densely dashed]
  ($(modelcard.south)+(0.0,0)$) -- (loss.north);

% ── Stage 6: Output ──
\node[block=emerald, text width=2.3cm, minimum height=1.5cm] (output) at (13.6, 0) {
  \textbf{\scriptsize Curve Output}\\
  {\tiny $\hat{\mathbf{J}}(V)$}\\
  {\tiny 8-pt + fine recon}
};
\node[lbl, below=1pt of output] {evaluated in\\absolute space};

\draw[arr] (modelcard.east) -- (output.west);

% ── Subtle stage background groups ──
\begin{scope}[on background layer]
  \node[fill=steel!3, rounded corners=6pt, inner sep=6pt,
    fit=(comsol)(scalar)(comsol_lbl-dummy)] {};
  % Just a faint wash behind the model card
  \fill[ink!2, rounded corners=6pt]
    ($(modelcard.south west)+(-0.12,-0.12)$) rectangle
    ($(modelcard.north east)+(0.12,0.12)$);
\end{scope}

% Dummy node for background fitting (invisible)
\coordinate (comsol_lbl-dummy) at ($(scalar)+(0,-0.55)$);

\end{tikzpicture}
\end{document}
